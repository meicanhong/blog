(window.webpackJsonp=window.webpackJsonp||[]).push([[47],{491:function(t,a,s){"use strict";s.r(a);var n=s(2),e=Object(n.a)({},(function(){var t=this,a=t._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"ai-agent-上下文工程实践-从长任务崩溃到稳定运行"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ai-agent-上下文工程实践-从长任务崩溃到稳定运行"}},[t._v("#")]),t._v(" AI Agent 上下文工程实践：从长任务崩溃到稳定运行")]),t._v(" "),a("p",[t._v("在构建高性能 AI Agent 的过程中，我发现真正限制长任务成功率的，往往不是底层模型能力，而是上下文管理。经过多次框架重构和数百万真实用户会话的验证，我们在 MaybeAi 沉淀出一套高度结构化的上下文工程体系。")]),t._v(" "),a("h2",{attrs:{id:"为什么上下文工程是核心竞争力"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#为什么上下文工程是核心竞争力"}},[t._v("#")]),t._v(" 为什么上下文工程是核心竞争力")]),t._v(" "),a("p",[t._v('Agent 竞争不是比模型，是比整个系统。真正影响成功率的，往往是任务拆解、工具链、失败重试、上下文管理这些工程细节。更关键的是，这套"上下文工程"的实践经验不是天上掉下来的，它需要在真实任务场景里一刀一枪练出来。')]),t._v(" "),a("p",[t._v('我们的 Agent 平均每个会话需要 50 步工具调用，处理的任务包括多文件数据分析、跨平台内容抓取、复杂报告生成等。如果上下文管理不当，Agent 会在第 20 步左右开始"目标漂移"，或者因为上下文窗口溢出直接崩溃。')]),t._v(" "),a("h2",{attrs:{id:"上下文设计的核心原则"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#上下文设计的核心原则"}},[t._v("#")]),t._v(" 上下文设计的核心原则")]),t._v(" "),a("h3",{attrs:{id:"文件系统是无限外部记忆"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#文件系统是无限外部记忆"}},[t._v("#")]),t._v(" 文件系统是无限外部记忆")]),t._v(" "),a("p",[t._v('把文件系统视为 Agent 的"终极上下文"：无限大小、持久化、可直接操作。任何大块内容（网页全文、CSV 数据、PDF、长日志）绝不直接放入上下文，而是保存到文件，只保留路径和必要摘要。')]),t._v(" "),a("div",{staticClass:"language-python extra-class"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 错误做法：把完整 CSV 内容放进上下文")]),t._v("\nobservation "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string-interpolation"}},[a("span",{pre:!0,attrs:{class:"token string"}},[t._v('f"CSV content: ')]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("full_csv_content"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")])]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"')])]),t._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 可能几万行")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 正确做法：外部化存储，只保留元信息")]),t._v("\nsave_file"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/data/stock_data.csv"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" csv_content"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nobservation "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"File saved to /data/stock_data.csv (756 rows, date range 2022-12-14 to 2025-12-14)"')]),t._v("\n")])])]),a("h3",{attrs:{id:"可逆压缩"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#可逆压缩"}},[t._v("#")]),t._v(" 可逆压缩")]),t._v(" "),a("p",[t._v("信息压缩后必须可恢复。我们不是丢弃信息，而是把它移到文件系统，需要时通过主动读取工具拉回。")]),t._v(" "),a("p",[t._v("比如处理一个 50 页的 PDF 财报：")]),t._v(" "),a("ul",[a("li",[t._v('上下文中只放："这是一份 50 页财报，关键点是营收增长 20%，路径：/reports/q3.pdf"')]),t._v(" "),a("li",[t._v("完整 PDF 内容存在文件里")]),t._v(" "),a("li",[t._v("后续需要时，Agent 调用 "),a("code",[t._v('read_file("/reports/q3.pdf")')]),t._v(" 获取")])]),t._v(" "),a("h3",{attrs:{id:"注意力操纵-recitation-机制"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#注意力操纵-recitation-机制"}},[t._v("#")]),t._v(" 注意力操纵：Recitation 机制")]),t._v(" "),a("p",[t._v('这是我们对抗"lost-in-the-middle"问题的核心武器。通过将最关键的信息（如当前计划和进度）强制追加到上下文最末尾，确保 LLM 的注意力机制优先看到。')]),t._v(" "),a("p",[t._v("核心文件是 "),a("code",[t._v("todo.md")]),t._v("：")]),t._v(" "),a("div",{staticClass:"language-markdown extra-class"},[a("pre",{pre:!0,attrs:{class:"language-markdown"}},[a("code",[a("span",{pre:!0,attrs:{class:"token title important"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("#")]),t._v(" 整体目标：分析 NVDA、MRVL、TSM 过去 3 年股票相关性并生成投资报告")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("-")]),t._v(" [x] 获取过去 3 年每日收盘价数据\n"),a("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("-")]),t._v(" [x] 下载并保存为 CSV 文件\n"),a("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("-")]),t._v(" [x] 清洗数据（处理缺失值、对齐日期）\n"),a("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("-")]),t._v(" [ ] 计算 Pearson 相关系数矩阵\n"),a("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("-")]),t._v(" [ ] 绘制相关性热力图和股价时间序列图\n"),a("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("-")]),t._v(" [ ] 分析见解\n"),a("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("-")]),t._v(" [ ] 评估风险\n"),a("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("-")]),t._v(" [ ] 生成最终报告\n\n当前进度：数据已清洗，下一步计算相关性。\n全局提醒：报告需客观、专业。\n")])])]),a("p",[t._v("每完成一个主要阶段（通常 3-10 步工具调用），Agent 必须更新 "),a("code",[t._v("todo.md")]),t._v("，然后系统自动将最新内容追加到上下文末尾。")]),t._v(" "),a("h2",{attrs:{id:"固定的四层上下文结构"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#固定的四层上下文结构"}},[t._v("#")]),t._v(" 固定的四层上下文结构")]),t._v(" "),a("p",[t._v("我们严格遵循以下四层顺序拼接上下文，确保可预测性和稳定性：")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("┌────────────────────────────────────────────┐\n│ 1. 系统提示（固定，最前）                    │\n├────────────────────────────────────────────┤\n│ 2. 历史行动-观察对（从旧到新，追加式）         │\n│    <action> ... </action>                    │\n│    <observation> ... </observation>          │\n│    <action> ... </action>                    │\n│    <observation> ... </observation>          │\n│    ...                                     │\n├────────────────────────────────────────────┤\n│ 3. 当前轮临时读取的文件内容（可选，仅本轮）     │\n├────────────────────────────────────────────┤\n│ 4. 关键文件 recitation（强制，最末尾）         │\n│    └─ todo.md 最新完整内容（必有）            │\n│    └─ 其他关键文件（如 insights.md，可选）    │\n└────────────────────────────────────────────┘\n")])])]),a("h3",{attrs:{id:"第一层-系统提示"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#第一层-系统提示"}},[t._v("#")]),t._v(" 第一层：系统提示")]),t._v(" "),a("p",[t._v("固定不变，放在最前面。包含 Agent 身份、能力描述、工具定义、核心原则。")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("You are MaybeAi, a powerful AI agent capable of browsing the web, executing code, reading/writing files, etc.\nTools available: browser_*, shell_*, read_file, write_file, ...\nKey principles: Use files as external memory. Always update todo.md after each major step. Keep context lean by summarizing large content...\n")])])]),a("h3",{attrs:{id:"第二层-历史行动-观察对"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#第二层-历史行动-观察对"}},[t._v("#")]),t._v(" 第二层：历史行动-观察对")]),t._v(" "),a("p",[t._v("追加式（append-only），从最旧到最新依次排列。每对的固定格式：")]),t._v(" "),a("div",{staticClass:"language-xml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-xml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("action")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("write_file")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("path")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("todo.md"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n# 整体目标：分析股票相关性\n- [ ] 获取数据\n...\n"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("write_file")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("action")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("observation")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\nFile todo.md created successfully.\n"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("observation")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("action")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("browser_navigate")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("url")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("https://finance.yahoo.com"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("/>")])]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("action")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("observation")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\nPage loaded. Title: Yahoo Finance - Stock Market Live...\n"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("observation")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n")])])]),a("p",[t._v("关键点：observation 里绝不放完整大内容，只放路径 + 摘要。")]),t._v(" "),a("h3",{attrs:{id:"第三层-当前轮临时读取内容"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#第三层-当前轮临时读取内容"}},[t._v("#")]),t._v(" 第三层：当前轮临时读取内容")]),t._v(" "),a("p",[t._v("仅在本轮需要时出现。如果 Agent 上一步调用了 "),a("code",[t._v("read_file")]),t._v("、"),a("code",[t._v("head")]),t._v("、"),a("code",[t._v("grep")]),t._v(' 等，工具返回的内容会直接追加在这里，作为本轮的"即时记忆"。')]),t._v(" "),a("div",{staticClass:"language-xml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-xml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("action")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("read_file")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("path")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("/data/stock_data.csv"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("/>")])]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("action")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("observation")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\nDate,Close\n2022-12-14,178.35\n2022-12-15,180.22\n...\n(756 rows total, showing first 100)\n"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("observation")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n")])])]),a("p",[t._v("下轮如果不再需要，这些内容不会被永久保留（除非 Agent 主动写到文件里）。")]),t._v(" "),a("h3",{attrs:{id:"第四层-关键文件-recitation"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#第四层-关键文件-recitation"}},[t._v("#")]),t._v(" 第四层：关键文件 Recitation")]),t._v(" "),a("p",[t._v('这是整个上下文结构的"杀手锏"，几乎每轮都必须有。放置位置：整个 context 的绝对末尾（最近位置），确保 LLM 的注意力机制优先看到。')]),t._v(" "),a("div",{staticClass:"language-markdown extra-class"},[a("pre",{pre:!0,attrs:{class:"language-markdown"}},[a("code",[t._v("[todo.md content start]\n"),a("span",{pre:!0,attrs:{class:"token title important"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("#")]),t._v(" 整体目标：分析 NVDA、MRVL、TSM 过去 3 年股票相关性并生成投资报告")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("-")]),t._v(" [x] 获取过去 3 年每日收盘价数据\n"),a("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("-")]),t._v(" [x] 下载并保存为 CSV 文件\n"),a("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("-")]),t._v(" [x] 清洗数据\n"),a("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("-")]),t._v(" [ ] 计算 Pearson 相关系数矩阵\n...\n\n当前进度：数据已清洗，下一步计算相关性。\n[todo.md content end]\n")])])]),a("h2",{attrs:{id:"长任务中的读写流程"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#长任务中的读写流程"}},[t._v("#")]),t._v(" 长任务中的读写流程")]),t._v(" "),a("p",[t._v('以"分析 NVDA、MRVL、TSM 过去三年股票价格相关性并生成投资报告"为例，展示完整的上下文演变过程。')]),t._v(" "),a("h3",{attrs:{id:"任务启动-第-1-轮"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#任务启动-第-1-轮"}},[t._v("#")]),t._v(" 任务启动（第 1 轮）")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v('[系统提示]\nYou are MaybeAi, a powerful AI agent...\n\n[历史行动-观察对]  // 目前为空\n\n[用户任务]\n分析 NVIDIA (NVDA)、Marvell Technology (MRVL) 和 TSMC (TSM) 过去三年股票价格的相关性，\n计算 Pearson 相关系数，绘制热力图和时间序列图，最后生成一份投资报告。\n\n[Agent 行动 1]\n<write_file path="todo.md">\n# 整体目标：分析 NVDA、MRVL、TSM 过去 3 年股票相关性并生成投资报告\n\n- [ ] 获取过去 3 年每日收盘价数据\n- [ ] 下载并保存为 CSV 文件\n- [ ] 清洗数据\n- [ ] 计算 Pearson 相关系数矩阵\n- [ ] 绘制相关性热力图和股价时间序列图\n- [ ] 分析见解\n- [ ] 评估风险\n- [ ] 生成最终报告\n\n当前进度：刚开始。\n</write_file>\n\n[观察 1]\nFile todo.md created successfully.\n\n[todo.md 最新内容 - recitation]\n# 整体目标：分析 NVDA、MRVL、TSM 过去 3 年股票相关性并生成投资报告\n...（完整内容）\n')])])]),a("p",[t._v("此时上下文大约 3-4k tokens。")]),t._v(" "),a("h3",{attrs:{id:"数据下载完成-第-8-轮"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#数据下载完成-第-8-轮"}},[t._v("#")]),t._v(" 数据下载完成（第 8 轮）")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("[系统提示]  // 固定\n\n[历史行动-观察对]  // 前面 7 轮的历史\n<action> download NVDA CSV </action>\n<observation> File saved to /data/nvda_data.csv (756 rows) </observation>\n\n<action> download MRVL CSV </action>\n<observation> File saved to /data/mrvl_data.csv (756 rows) </observation>\n\n<action> download TSM CSV </action>\n<observation> File saved to /data/tsm_data.csv (756 rows) </observation>\n\n<action> 更新 todo.md </action>\n<observation> todo.md updated </observation>\n\n[todo.md 最新内容 - recitation]\n- [x] 获取过去 3 年每日收盘价数据\n- [x] 下载并保存为 CSV 文件\n- [ ] 清洗数据（处理缺失值、对齐日期）\n...\n\n当前进度：数据已下载，下一步清洗。\n")])])]),a("p",[t._v("此时上下文大约 15-20k tokens。注意：CSV 原始数据完全没进来，只在观察里提了一句路径。")]),t._v(" "),a("h3",{attrs:{id:"数据清洗阶段-第-12-轮"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#数据清洗阶段-第-12-轮"}},[t._v("#")]),t._v(" 数据清洗阶段（第 12 轮）")]),t._v(" "),a("p",[t._v("Agent 决定清洗数据，需要读取 CSV。")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v('[系统提示 + 历史行动-观察对]  // 前面所有历史\n\n[最近行动]\n<read_file path="/data/nvda_data.csv" />\n<read_file path="/data/mrvl_data.csv" />\n<read_file path="/data/tsm_data.csv" />\n\n[观察]\nnvda_data.csv content: (返回前 100 行 + 统计摘要)\nDate,Close\n2022-12-14,178.35\n...\n(756 rows total)\n\n[todo.md 最新内容 - recitation]\n- [x] 获取...\n- [x] 下载...\n- [ ] 清洗数据（处理缺失值、对齐日期）   ← 当前焦点\n...\n')])])]),a("p",[t._v("这轮上下文临时变大（因为读了三个 CSV 片段），但下轮清洗完后，Agent 会把清洗结果保存为新文件 "),a("code",[t._v("cleaned_data.csv")]),t._v("，下次就不需要再读原始 CSV 了。")]),t._v(" "),a("h3",{attrs:{id:"任务接近尾声-第-25-轮"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#任务接近尾声-第-25-轮"}},[t._v("#")]),t._v(" 任务接近尾声（第 25 轮）")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("[系统提示 + 完整历史行动-观察对]  // 约 50 步历史\n\n[最近几轮关键观察摘要]\n- cleaned_data.csv saved (756 aligned rows)\n- Pearson correlation matrix: NVDA-MRVL: 0.85, NVDA-TSM: 0.78\n- heatmap.png saved to /images/heatmap.png\n- price_chart.png saved to /images/price_chart.png\n- insights.md written\n- todo.md updated: all items checked except final report\n\n[todo.md 最新内容 - recitation]\n- [x] 获取过去 3 年每日收盘价数据\n- [x] 下载并保存为 CSV 文件\n- [x] 清洗数据\n- [x] 计算 Pearson 相关系数矩阵\n- [x] 绘制相关性热力图和股价时间序列图\n- [x] 分析见解\n- [x] 评估风险\n- [ ] 生成最终报告（Markdown + 图表）\n\n当前进度：所有分析完成，只剩合成报告。\n")])])]),a("p",[t._v("最终生成报告时，Agent 会再次 "),a("code",[t._v("read_file")]),t._v(" 读取 "),a("code",[t._v("insights.md")]),t._v("、图路径等必要片段，合成最终 Markdown。")]),t._v(" "),a("h2",{attrs:{id:"关键文件的使用规范"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#关键文件的使用规范"}},[t._v("#")]),t._v(" 关键文件的使用规范")]),t._v(" "),a("h3",{attrs:{id:"todo-md-agent-的外部大脑"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#todo-md-agent-的外部大脑"}},[t._v("#")]),t._v(" todo.md：Agent 的外部大脑")]),t._v(" "),a("p",[t._v("每完成一个主要阶段（通常 3-10 步工具调用）必须更新：")]),t._v(" "),a("ul",[a("li",[t._v("勾选已完成项")]),t._v(" "),a("li",[t._v("调整剩余任务顺序")]),t._v(" "),a("li",[t._v("重述全局目标")])]),t._v(" "),a("p",[t._v("更新后立即 recitation 到上下文末尾。")]),t._v(" "),a("h3",{attrs:{id:"其他常见文件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#其他常见文件"}},[t._v("#")]),t._v(" 其他常见文件")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",[t._v("文件类型")]),t._v(" "),a("th",[t._v("用途")]),t._v(" "),a("th",[t._v("示例")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[t._v("中间数据")]),t._v(" "),a("td",[t._v("存储处理结果")]),t._v(" "),a("td",[a("code",[t._v("cleaned_data.csv")]),t._v(", "),a("code",[t._v("analysis_result.json")])])]),t._v(" "),a("tr",[a("td",[t._v("错误日志")]),t._v(" "),a("td",[t._v("保留完整错误栈")]),t._v(" "),a("td",[a("code",[t._v("error_log.txt")]),t._v(", "),a("code",[t._v("logs.json")])])]),t._v(" "),a("tr",[a("td",[t._v("草稿笔记")]),t._v(" "),a("td",[t._v("临时思考和见解")]),t._v(" "),a("td",[a("code",[t._v("insights.md")]),t._v(", "),a("code",[t._v("draft.md")]),t._v(", "),a("code",[t._v("scratchpad.txt")])])]),t._v(" "),a("tr",[a("td",[t._v("图像路径")]),t._v(" "),a("td",[t._v("生成的图表")]),t._v(" "),a("td",[a("code",[t._v("heatmap.png")]),t._v(", "),a("code",[t._v("price_chart.png")])])])])]),t._v(" "),a("p",[t._v("这些文件按需读取，读取后内容仅用于当前或后续几轮推理。")]),t._v(" "),a("h2",{attrs:{id:"四大工程模块的核心经验"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#四大工程模块的核心经验"}},[t._v("#")]),t._v(" 四大工程模块的核心经验")]),t._v(" "),a("h3",{attrs:{id:"任务拆解"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#任务拆解"}},[t._v("#")]),t._v(" 任务拆解")]),t._v(" "),a("p",[a("strong",[t._v("核心做法")]),t._v("：")]),t._v(" "),a("ul",[a("li",[t._v('将复杂任务拆解为 ~50 步工具调用链，每步遵循"选择行动 → 执行 → 追加观察"的循环')]),t._v(" "),a("li",[t._v("使用 "),a("code",[t._v("todo.md")]),t._v(' 作为"外部大脑"，明确分解粒度（按"5 秒级操作单元"）')]),t._v(" "),a("li",[t._v("支持子代理（sub-agents）隔离子任务，共享上下文但独立窗口")])]),t._v(" "),a("p",[a("strong",[t._v("关键教训")]),t._v("：")]),t._v(" "),a("ul",[a("li",[t._v('长序列易导致"目标漂移"和"中间丢失"问题')]),t._v(" "),a("li",[t._v("通过 recitation 机制，成功率提升 20-30%，无需重训模型")]),t._v(" "),a("li",[t._v('任务粒度过粗会导致级联失败，优化后按"5 秒级操作单元"拆解')])]),t._v(" "),a("h3",{attrs:{id:"工具链"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#工具链"}},[t._v("#")]),t._v(" 工具链")]),t._v(" "),a("p",[a("strong",[t._v("核心做法")]),t._v("：")]),t._v(" "),a("ul",[a("li",[t._v("采用上下文感知状态机管理工具，不动态加载/卸载（避免 KV-cache 失效）")]),t._v(" "),a("li",[t._v("用 logit masking（解码时屏蔽 token 概率）约束选择")]),t._v(" "),a("li",[t._v("工具设计标准化：统一前缀（如 "),a("code",[t._v("browser_*")]),t._v(", "),a("code",[t._v("shell_*")]),t._v("），总工具数控制在 <20 个原子工具")])]),t._v(" "),a("p",[a("strong",[t._v("关键教训")]),t._v("：")]),t._v(" "),a("ul",[a("li",[t._v('动态工具切换在生产中常引发"schema violation"')]),t._v(" "),a("li",[t._v("masking 后，工具调用稳定性达 99%")]),t._v(" "),a("li",[t._v("通过前缀分组和沙箱，减少了 80% 的工具输出噪声")])]),t._v(" "),a("h3",{attrs:{id:"失败重试"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#失败重试"}},[t._v("#")]),t._v(" 失败重试")]),t._v(" "),a("p",[a("strong",[t._v("核心做法")]),t._v("：")]),t._v(" "),a("ul",[a("li",[t._v("保留所有失败痕迹：行动、观察和错误日志追加到上下文中")]),t._v(" "),a("li",[t._v("自调试机制：日志流记录失败上下文，供重试时引用")]),t._v(" "),a("li",[t._v('支持"部分回滚"：失败步骤隔离重跑，而非全序列重启')])]),t._v(" "),a("p",[a("strong",[t._v("关键教训")]),t._v("：")]),t._v(" "),a("ul",[a("li",[t._v('隐藏失败是"伪优化"：早期版本清理错误导致模型重复犯错')]),t._v(" "),a("li",[t._v('保留失败后，Agent 学会"避坑"，重试效率提升')]),t._v(" "),a("li",[t._v("错误恢复率从 30% 升至 70%")])]),t._v(" "),a("h3",{attrs:{id:"上下文管理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#上下文管理"}},[t._v("#")]),t._v(" 上下文管理")]),t._v(" "),a("p",[a("strong",[t._v("核心做法")]),t._v("：")]),t._v(" "),a("ul",[a("li",[t._v('文件系统作为"无限上下文"，保存中间结果')]),t._v(" "),a("li",[t._v("可恢复压缩：大文件外部化但留路径，确保信息不永久丢失")]),t._v(" "),a("li",[t._v("操纵注意力：通过 todo 背诵推全局计划到上下文末尾")]),t._v(" "),a("li",[t._v("确定性追加：稳定 JSON 序列化，避免时间戳变异")])]),t._v(" "),a("p",[a("strong",[t._v("关键教训")]),t._v("：")]),t._v(" "),a("ul",[a("li",[t._v("上下文膨胀是 Agent 杀手：无优化时，50 步后窗口溢出")]),t._v(" "),a("li",[t._v("文件外部化 + 压缩后，成本降 50%，支持长任务")]),t._v(" "),a("li",[t._v('上下文工程是"船而非建筑"：随模型进步迭代')])]),t._v(" "),a("h2",{attrs:{id:"实际效果"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#实际效果"}},[t._v("#")]),t._v(" 实际效果")]),t._v(" "),a("p",[t._v("经过这套体系的打磨，我们在 MaybeAi 取得了以下成果：")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",[t._v("指标")]),t._v(" "),a("th",[t._v("优化前")]),t._v(" "),a("th",[t._v("优化后")]),t._v(" "),a("th",[t._v("提升")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[t._v("长任务成功率")]),t._v(" "),a("td",[t._v("50%")]),t._v(" "),a("td",[t._v("96%+")]),t._v(" "),a("td",[t._v("+92%")])]),t._v(" "),a("tr",[a("td",[t._v("上下文 token 消耗")]),t._v(" "),a("td",[t._v("基准")]),t._v(" "),a("td",[t._v("-50%")]),t._v(" "),a("td",[t._v("成本减半")])]),t._v(" "),a("tr",[a("td",[t._v("错误恢复率")]),t._v(" "),a("td",[t._v("30%")]),t._v(" "),a("td",[t._v("70%")]),t._v(" "),a("td",[t._v("+133%")])]),t._v(" "),a("tr",[a("td",[t._v("支持最大步数")]),t._v(" "),a("td",[t._v("~20 步")]),t._v(" "),a("td",[t._v("50+ 步")]),t._v(" "),a("td",[t._v("+150%")])]),t._v(" "),a("tr",[a("td",[t._v("目标漂移率")]),t._v(" "),a("td",[t._v("高")]),t._v(" "),a("td",[t._v("近零")]),t._v(" "),a("td",[t._v("显著改善")])])])]),t._v(" "),a("p",[t._v('在第三方基准测试中，自动化率和多步任务成功率位居前列。用户反馈："Agent 记性超好，不会忘中间结果"、"现在它像个可靠的助手，不会半途而废"。')]),t._v(" "),a("h2",{attrs:{id:"核心洞察"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#核心洞察"}},[t._v("#")]),t._v(" 核心洞察")]),t._v(" "),a("p",[t._v("回顾整个上下文工程的迭代过程，几个关键认知：")]),t._v(" "),a("p",[a("strong",[t._v("失败不是 bug，而是 feature")]),t._v("。保留失败痕迹让 Agent 能够自适应学习，避免重复犯错。")]),t._v(" "),a("p",[a("strong",[t._v("上下文不是垃圾桶，而是可塑工具")]),t._v('。Agent 不是死记硬背，而是像程序员一样"查文件、看笔记"。')]),t._v(" "),a("p",[a("strong",[t._v("文件系统是最好的外部记忆")]),t._v("。无限大小、持久化、可直接操作，完美解决上下文窗口限制。")]),t._v(" "),a("p",[a("strong",[t._v("Recitation 是对抗遗忘的利器")]),t._v("。将关键信息强制放在上下文末尾，利用 LLM 的注意力机制特性。")]),t._v(" "),a("p",[a("strong",[t._v("工程壁垒远超模型")]),t._v("。当大模型能力趋于同质化，上下文工程已成为 Agent 领域最值得深耕的差异化方向。")]),t._v(" "),a("h2",{attrs:{id:"总结"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[t._v("#")]),t._v(" 总结")]),t._v(" "),a("p",[t._v("这套结构化、文件驱动、可逆的上下文管理体系，既是我们在生产环境中的实战结晶，也适用于任何希望构建可靠长任务 Agent 的团队。")]),t._v(" "),a("p",[t._v("上下文工程不是一次性设计，而是持续迭代的过程。我们经历了四次框架重构，每次都是从真实用户反馈中提炼原则。这个过程没有捷径，必须在真实任务场景里一刀一枪练出来。")]),t._v(" "),a("p",[t._v("未来，随着模型上下文窗口继续扩大，这套体系仍将保持价值——因为高效的记忆管理永远是智能体的核心竞争力。")])])}),[],!1,null,null,null);a.default=e.exports}}]);