(window.webpackJsonp=window.webpackJsonp||[]).push([[52],{495:function(t,s,a){"use strict";a.r(s);var n=a(2),e=Object(n.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"opencode-skill-系统深度解析-从工具注册到-ai-执行的完整链路"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#opencode-skill-系统深度解析-从工具注册到-ai-执行的完整链路"}},[t._v("#")]),t._v(" OpenCode Skill 系统深度解析：从工具注册到 AI 执行的完整链路")]),t._v(" "),s("p",[t._v("前几天在探索 OpenCode 项目时，我注意到一个有趣的问题：这个项目支持 skills 吗？随着一层层代码的追踪，我发现了一个设计精巧的系统——Skill 不是什么特殊的魔法，而是作为普通的 Tool 深度集成到 Agent 架构中。")]),t._v(" "),s("p",[t._v("这篇文章记录了我对 OpenCode Skill 系统的完整探索过程，从最初的疑问到对整个架构的深入理解。")]),t._v(" "),s("h2",{attrs:{id:"问题起源"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#问题起源"}},[t._v("#")]),t._v(" 问题起源")]),t._v(" "),s("p",[t._v("一切始于一个简单的问题：OpenCode 支持 skills 吗？")]),t._v(" "),s("p",[t._v("通过搜索代码库，我很快发现了完整的 Skill 系统：")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("packages/opencode/src/skill/skill.ts    - Skill 扫描、解析和状态管理\npackages/opencode/src/tool/skill.ts      - Skill 工具，将 skills 暴露给 AI\npackages/opencode/src/cli/cmd/debug/skill.ts  - 调试命令\npackages/opencode/test/skill/skill.test.ts    - 测试\n")])])]),s("p",[t._v("项目会扫描两个位置：")]),t._v(" "),s("ul",[s("li",[s("code",[t._v(".opencode/skill/")]),t._v(" 或 "),s("code",[t._v(".opencode/skills/")]),t._v(" —— OpenCode 原生格式")]),t._v(" "),s("li",[s("code",[t._v(".claude/skills/")]),t._v(" —— Claude Code 兼容格式")])]),t._v(" "),s("p",[t._v("每个 skill 需要一个 "),s("code",[t._v("SKILL.md")]),t._v(" 文件，包含 frontmatter（name、description）和内容。")]),t._v(" "),s("h2",{attrs:{id:"深入探索-skill-如何在-agent-runtime-中发挥作用"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#深入探索-skill-如何在-agent-runtime-中发挥作用"}},[t._v("#")]),t._v(" 深入探索：Skill 如何在 Agent Runtime 中发挥作用？")]),t._v(" "),s("p",[t._v("理解 Skill 的存在只是开始。真正有趣的问题是：当 Agent 运行时，这些 Skill 是如何发挥作用的？")]),t._v(" "),s("h3",{attrs:{id:"第一步-skill-作为-tool-注册"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#第一步-skill-作为-tool-注册"}},[t._v("#")]),t._v(" 第一步：Skill 作为 Tool 注册")]),t._v(" "),s("p",[t._v("打开 "),s("code",[t._v("packages/opencode/src/tool/registry.ts")]),t._v("，我看到 SkillTool 被添加到全局工具列表中：")]),t._v(" "),s("div",{staticClass:"language-typescript extra-class"},[s("pre",{pre:!0,attrs:{class:"language-typescript"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// packages/opencode/src/tool/registry.ts:111")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n  InvalidTool"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  QuestionTool"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  BashTool"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  ReadTool"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ... 其他工具")]),t._v("\n  SkillTool"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ← Skill 工具位置")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("custom"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n")])])]),s("p",[s("strong",[t._v("关键发现")]),t._v("：Skill 不是独立的系统组件，而是作为普通工具注册。")]),t._v(" "),s("h3",{attrs:{id:"第二步-工具解析与权限过滤"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#第二步-工具解析与权限过滤"}},[t._v("#")]),t._v(" 第二步：工具解析与权限过滤")]),t._v(" "),s("p",[t._v("在 Agent 运行时，"),s("code",[t._v("ToolRegistry.tools()")]),t._v(" 被调用，SkillTool.init() 执行，根据 agent 权限过滤 skills：")]),t._v(" "),s("div",{staticClass:"language-typescript extra-class"},[s("pre",{pre:!0,attrs:{class:"language-typescript"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// packages/opencode/src/session/prompt.ts:688-691")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ToolRegistry.tools() 被调用")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// SkillTool.init() 执行，根据 agent 权限过滤 skills")]),t._v("\n")])])]),s("p",[t._v("这意味着不同的 agent 可以看到不同的技能列表——权限系统在工具层面就做了控制。")]),t._v(" "),s("h3",{attrs:{id:"第三步-动态生成工具描述"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#第三步-动态生成工具描述"}},[t._v("#")]),t._v(" 第三步：动态生成工具描述")]),t._v(" "),s("p",[t._v("SkillTool 会动态生成包含可用技能列表的描述：")]),t._v(" "),s("div",{staticClass:"language-typescript extra-class"},[s("pre",{pre:!0,attrs:{class:"language-typescript"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// packages/opencode/src/tool/skill.ts:16-39")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 生成包含可用技能列表的 description")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// AI 能看到所有可访问的 skill 及其描述")]),t._v("\n")])])]),s("p",[t._v("比如描述可能是这样的：")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v('"Load a skill to get detailed instructions for a specific task.\nSkills provide specialized knowledge and step-by-step guidance.\nUse this when a task matches an available skill\'s description."\n\n<available_skills>\n  <skill>\n    <name>commit</name>\n    <description>Create git commits</description>\n  </skill>\n  <skill>\n    <name>code-review</name>\n    <description>Review code changes</description>\n  </skill>\n</available_skills>\n')])])]),s("h3",{attrs:{id:"第四步-ai-调用后的完整流程"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#第四步-ai-调用后的完整流程"}},[t._v("#")]),t._v(" 第四步：AI 调用后的完整流程")]),t._v(" "),s("p",[t._v("当 AI 决定使用某个 Skill 时，完整的执行流程是这样的：")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("1. AI 调用 skill 工具\n   ↓\n2. 权限检查 (PermissionNext.ask)\n   ↓\n3. 读取 SKILL.md 内容\n   ↓\n4. 返回 skill 的完整内容给 AI\n   ↓\n5. 内容进入对话历史\n   ↓\n6. AI 阅读并遵循指令继续执行\n")])])]),s("p",[s("strong",[t._v("关键洞察")]),t._v("：Skill 是一次性指令注入，不是持久模式切换。返回的 skill 内容会直接进入对话历史，AI 阅读后会自主遵循 skill 中的指令。")]),t._v(" "),s("h2",{attrs:{id:"agent-如何挑选-tool-skills"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#agent-如何挑选-tool-skills"}},[t._v("#")]),t._v(" Agent 如何挑选 Tool/Skills？")]),t._v(" "),s("p",[t._v("这是一个有趣的问题：如果有个 Tool 和 Skill 的能力重叠，Agent 会优先选哪个？")]),t._v(" "),s("p",[t._v("通过分析代码，我发现了几个影响选择的因素：")]),t._v(" "),s("h3",{attrs:{id:"_1-描述质量"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-描述质量"}},[t._v("#")]),t._v(" 1. 描述质量")]),t._v(" "),s("p",[t._v("没有硬编码的优先级。选择完全依赖 AI 模型对描述的理解。")]),t._v(" "),s("p",[t._v('假设有 "commit" skill 和 "git-commit" tool 能力重叠：')]),t._v(" "),s("div",{staticClass:"language-markdown extra-class"},[s("pre",{pre:!0,attrs:{class:"language-markdown"}},[s("code",[s("span",{pre:!0,attrs:{class:"token title important"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("#")]),t._v(' Skill: "Create git commits following best practices"')]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token title important"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("#")]),t._v(' Tool: "Create git commits"')]),t._v("\n")])])]),s("p",[t._v("AI 可能选择 Skill，因为：")]),t._v(" "),s("ul",[s("li",[t._v('描述更具体（"best practices"）')]),t._v(" "),s("li",[t._v('承诺提供 "specialized knowledge"')])]),t._v(" "),s("p",[t._v("但如果 Tool 描述更好：")]),t._v(" "),s("div",{staticClass:"language-markdown extra-class"},[s("pre",{pre:!0,attrs:{class:"language-markdown"}},[s("code",[s("span",{pre:!0,attrs:{class:"token title important"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("#")]),t._v(' Skill: "Git operations"  # 太模糊')]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token title important"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("#")]),t._v(' Tool: "Create commits with conventional format"  # 具体')]),t._v("\n")])])]),s("p",[t._v("AI 可能选择 Tool。")]),t._v(" "),s("h3",{attrs:{id:"_2-列表顺序的影响"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-列表顺序的影响"}},[t._v("#")]),t._v(" 2. 列表顺序的影响")]),t._v(" "),s("p",[t._v("工具列表的顺序有轻微影响，但现代 AI 模型通常能理解全部工具，不会只看前面的。")]),t._v(" "),s("h3",{attrs:{id:"_3-设计权衡"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-设计权衡"}},[t._v("#")]),t._v(" 3. 设计权衡")]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",[t._v("方面")]),t._v(" "),s("th",[t._v("Skill")]),t._v(" "),s("th",[t._v("Tool")])])]),t._v(" "),s("tbody",[s("tr",[s("td",[t._v("描述位置")]),t._v(" "),s("td",[t._v("动态生成 (skill.ts:24-39)")]),t._v(" "),s("td",[t._v("代码硬编码")])]),t._v(" "),s("tr",[s("td",[t._v("描述丰富度")]),t._v(" "),s("td",[t._v("包含完整技能列表")]),t._v(" "),s("td",[t._v("通常简短")])]),t._v(" "),s("tr",[s("td",[t._v("更新成本")]),t._v(" "),s("td",[t._v("修改 SKILL.md")]),t._v(" "),s("td",[t._v("需要改代码")])]),t._v(" "),s("tr",[s("td",[t._v("AI 偏好")]),t._v(" "),s("td",[t._v('承诺"详细指令"可能更吸引')]),t._v(" "),s("td",[t._v("依赖描述质量")])])])]),t._v(" "),s("h2",{attrs:{id:"标准化的-tool-call-流程"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#标准化的-tool-call-流程"}},[t._v("#")]),t._v(" 标准化的 Tool Call 流程")]),t._v(" "),s("p",[t._v("Skill 执行会经过标准化的 tool call 流程吗？")]),t._v(" "),s("p",[t._v("答案是："),s("strong",[t._v("完全标准化")]),t._v("。")]),t._v(" "),s("h3",{attrs:{id:"ai-sdk-包装层"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#ai-sdk-包装层"}},[t._v("#")]),t._v(" AI SDK 包装层")]),t._v(" "),s("div",{staticClass:"language-typescript extra-class"},[s("pre",{pre:!0,attrs:{class:"language-typescript"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// packages/opencode/src/session/prompt.ts:688-729")]),t._v("\ntools"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"skill"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("tool")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  id"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"skill"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  description"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Load a skill..."')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  inputSchema"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("jsonSchema")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("execute")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("args"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" options"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("toModelOutput")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("result"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),s("h3",{attrs:{id:"sessionprocessor-事件处理"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#sessionprocessor-事件处理"}},[t._v("#")]),t._v(" SessionProcessor 事件处理")]),t._v(" "),s("div",{staticClass:"language-typescript extra-class"},[s("pre",{pre:!0,attrs:{class:"language-typescript"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// packages/opencode/src/session/processor.ts:126-194")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("case")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"tool-call"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 创建 ToolPart，状态: running")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" Session"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("updatePart")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    type"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"tool"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    tool"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"skill"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    state"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" status"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"running"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" input"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("name"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"commit"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("case")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"tool-result"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" Session"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("updatePart")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    state"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" status"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"completed"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" output"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"..."')]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[t._v("Skill 与其他工具（Bash、Read、Edit）走的是完全一致的执行路径。")]),t._v(" "),s("h2",{attrs:{id:"execute-的统一与差异"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#execute-的统一与差异"}},[t._v("#")]),t._v(" Execute 的统一与差异")]),t._v(" "),s("p",[t._v("最后，我探索了 Skill 的 execute 实现。是统一实现吗？")]),t._v(" "),s("p",[t._v("答案："),s("strong",[t._v("架构层面统一，实现层面各异")]),t._v("。")]),t._v(" "),s("h3",{attrs:{id:"通用层-统一"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#通用层-统一"}},[t._v("#")]),t._v(" 通用层（统一）")]),t._v(" "),s("div",{staticClass:"language-typescript extra-class"},[s("pre",{pre:!0,attrs:{class:"language-typescript"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// packages/opencode/src/tool/tool.ts:47-87")]),t._v("\nTool"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("define")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("id"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" init"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 包装原始 execute 方法")]),t._v("\n  toolInfo"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("execute")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("args"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" ctx"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 1. 统一参数验证")]),t._v("\n    toolInfo"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("parameters"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("parse")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("args"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 2. 调用原始 execute")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" result "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("execute")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("args"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" ctx"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 3. 统一输出截断")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" truncated "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" Truncate"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("output")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("result"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("output"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" initCtx"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?.")]),t._v("agent"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("result"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" output"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" truncated"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("content"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" metadata"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("h3",{attrs:{id:"各工具实现层-各异"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#各工具实现层-各异"}},[t._v("#")]),t._v(" 各工具实现层（各异）")]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",[t._v("工具")]),t._v(" "),s("th",[t._v("execute 实现特点")])])]),t._v(" "),s("tbody",[s("tr",[s("td",[t._v("BashTool")]),t._v(" "),s("td",[t._v("执行命令、解析参数、权限检查")])]),t._v(" "),s("tr",[s("td",[t._v("ReadTool")]),t._v(" "),s("td",[t._v("路径解析、外部目录检查、文件读取")])]),t._v(" "),s("tr",[s("td",[t._v("SkillTool")]),t._v(" "),s("td",[t._v("获取 skill、权限检查、解析 SKILL.md")])])])]),t._v(" "),s("p",[t._v("这是典型的"),s("strong",[t._v("模板方法模式")]),t._v("：")]),t._v(" "),s("ul",[s("li",[t._v("通用层定义骨架（验证 → 执行 → 截断）")]),t._v(" "),s("li",[t._v("各工具实现核心业务逻辑")])]),t._v(" "),s("h2",{attrs:{id:"总结"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[t._v("#")]),t._v(" 总结")]),t._v(" "),s("p",[t._v("通过这次探索，我对 OpenCode Skill 系统有了完整的理解：")]),t._v(" "),s("ol",[s("li",[s("strong",[t._v("非侵入式设计")]),t._v("：Skill 只是普通工具，通过工具系统调用")]),t._v(" "),s("li",[s("strong",[t._v("按需加载")]),t._v("：只在 AI 调用时才读取 SKILL.md 文件内容")]),t._v(" "),s("li",[s("strong",[t._v("权限感知")]),t._v("：不同 agent 根据权限看到不同的技能列表")]),t._v(" "),s("li",[s("strong",[t._v("兼容性")]),t._v("：支持 Claude Code 的 "),s("code",[t._v(".claude/skills/")]),t._v(" 格式")]),t._v(" "),s("li",[s("strong",[t._v("标准化流程")]),t._v("：完全通过 AI SDK 的 tool() 机制执行")]),t._v(" "),s("li",[s("strong",[t._v("两层架构")]),t._v("：通用层处理验证+截断，各工具实现业务逻辑")])]),t._v(" "),s("p",[t._v('最让我印象深刻的是 Skill 的"一次性指令注入"设计——它不是切换到一个特殊的"skill 模式"，而是将指令作为文本返回给 AI，让 AI 自主理解和遵循。这种设计既保持了系统的简洁性，又赋予了 AI 足够的灵活性。')]),t._v(" "),s("p",[t._v("如果你也在设计类似的 AI Agent 系统，OpenCode 的 Skill 系统值得作为参考案例研究。")])])}),[],!1,null,null,null);s.default=e.exports}}]);